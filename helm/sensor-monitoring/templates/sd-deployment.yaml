{{- if .Values.serviceDiscovery.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "sensor-monitoring.fullname" . }}-sd
  labels:
    {{- include "sensor-monitoring.labels" . | nindent 4 }}
    app.kubernetes.io/component: service-discovery
spec:
  replicas: {{ .Values.serviceDiscovery.replicaCount }}
  selector:
    matchLabels:
      {{- include "sensor-monitoring.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: service-discovery
  template:
    metadata:
      labels:
        {{- include "sensor-monitoring.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: service-discovery
    spec:
      containers:
      - name: service-discovery
        image: "{{ .Values.serviceDiscovery.image.repository }}:{{ .Values.serviceDiscovery.image.tag }}"
        imagePullPolicy: {{ .Values.serviceDiscovery.image.pullPolicy }}
        env:
        - name: INVENTORY_URL
          value: {{ .Values.serviceDiscovery.config.inventoryUrl | quote }}
        - name: UPDATE_INTERVAL
          value: {{ .Values.serviceDiscovery.config.updateInterval | quote }}
        - name: TARGETS_FILE
          value: "/shared/targets.json"
        - name: METRICS_PORT
          value: {{ .Values.serviceDiscovery.config.metricsPort | quote }}
        - name: METRICS_PATH
          value: {{ .Values.serviceDiscovery.config.metricsPath | quote }}
        volumeMounts:
        - name: targets
          mountPath: /shared
        livenessProbe:
          exec:
            command:
            - test
            - -f
            - /shared/targets.json
          initialDelaySeconds: 15
          periodSeconds: 30
        resources:
          {{- toYaml .Values.serviceDiscovery.resources | nindent 10 }}
      volumes:
      - name: targets
        persistentVolumeClaim:
          claimName: {{ include "sensor-monitoring.fullname" . }}-targets
{{- end }}

